cscope 15 $HOME/linux-conf/test_dir/threadpool/threadpool -q 0000000071 0000005918
	@threadpool.c

1 #ifdeà
__ılu¥lus


5 
	~"th»adpoŞ.h
"

7 
	sjob


9 
EPOLL_EV_CB
 
ÿÎback
;

10 *
¬g
;

11 
job
 *
Ãxt
;

14 
	sth»adpoŞ


16 
th»ad_num
;

17 
queue_max_num
;

18 
job
 *
h—d
;

19 
job
 *

;

20 
±h»ad_t
 *
±h»ads
;

21 
±h»ad_mu‹x_t
 
mu‹x
;

22 
±h»ad_cÚd_t
 
queue_em±y
;

23 
±h»ad_cÚd_t
 
queue_nÙ_em±y
;

24 
±h»ad_cÚd_t
 
queue_nÙ_fuÎ
;

25 
queue_cur_num
;

26 
queue_şo£
;

27 
poŞ_şo£
;

28 }
	tTHREAD_POOL_S
;

30 
g_bth»adpoŞ_š™
 = 0;

31 
THREAD_POOL_S
 *
g¡_±h»adpoŞ
 = 
NULL
;

33 
THREAD_POOL_S
* 
th»adpoŞ_š™
(
th»ad_num
, 
queue_max_num
);

34 
th»adpoŞ_add_job
(
th»adpoŞ
 *
poŞ
, 
EPOLL_EV_CB
 
ÿÎback
, *
¬g
);

35 
th»adpoŞ_de¡roy
(
th»adpoŞ
 *
poŞ
);

36 * 
th»adpoŞ_funùiÚ
(* 
¬g
);

38 
th»adpoŞ
* 
th»adpoŞ_š™
(
th»ad_num
, 
queue_max_num
)

40 
th»adpoŞ
 *
poŞ
 = 
NULL
;

43 
poŞ
 = (
th»adpoŞ
 *)
m®loc
((threadpool));

44 ià(
NULL
 =ğ
poŞ
)

46 
´štf
("failedo mallochreadpool!\n");

49 
mem£t
(
poŞ
, 0, (
th»adpoŞ
));

50 
poŞ
->
th»ad_num
 =hread_num;

51 
poŞ
->
queue_max_num
 = queue_max_num;

52 
poŞ
->
queue_cur_num
 = 0;

53 
poŞ
->
h—d
 = 
NULL
;

54 
poŞ
->

 = 
NULL
;

55 ià(
±h»ad_mu‹x_š™
(&(
poŞ
->
mu‹x
), 
NULL
))

57 
´štf
("failedo init mutex!\n");

60 ià(
±h»ad_cÚd_š™
(&(
poŞ
->
queue_em±y
), 
NULL
))

62 
´štf
("failedo init queue_empty!\n");

65 ià(
±h»ad_cÚd_š™
(&(
poŞ
->
queue_nÙ_em±y
), 
NULL
))

67 
´štf
("failedo init queue_not_empty!\n");

70 ià(
±h»ad_cÚd_š™
(&(
poŞ
->
queue_nÙ_fuÎ
), 
NULL
))

72 
´štf
("failedo init queue_not_full!\n");

75 
poŞ
->
±h»ads
 = (
±h»ad_t
 *)
m®loc
(Õth»ad_tè* 
th»ad_num
);

76 ià(
NULL
 =ğ
poŞ
->
±h»ads
)

78 
´štf
("failedo malloc…threads!\n");

81 
mem£t
(
poŞ
->
±h»ads
, 0, (
±h»ad_t
è* 
th»ad_num
);

83 
poŞ
->
queue_şo£
 = 0;

84 
poŞ
->
poŞ_şo£
 = 0;

85 
i
;

86 
i
 = 0; i < 
poŞ
->
th»ad_num
; ++i)

88 
±h»ad_ü—‹
(&(
poŞ
->
±h»ads
[
i
]), 
NULL
, 
th»adpoŞ_funùiÚ
, (*)pool);

91  
poŞ
;

94  
NULL
;

97 
th»adpoŞ_add_job
(
th»adpoŞ
* 
poŞ
, 
EPOLL_EV_CB
 
ÿÎback
, *
¬g
)

99 
as£¹
(
poŞ
 !ğ
NULL
);

100 
as£¹
(
ÿÎback
 !ğ
NULL
);

101 
as£¹
(
¬g
 !ğ
NULL
);

103 
±h»ad_mu‹x_lock
(&(
poŞ
->
mu‹x
));

104 (
poŞ
->
queue_cur_num
 >ğpoŞ->
queue_max_num
è&& !ÕoŞ->
queue_şo£
 ||…oŞ->
poŞ_şo£
))

106 
±h»ad_cÚd_wa™
(&(
poŞ
->
queue_nÙ_fuÎ
), &ÕoŞ->
mu‹x
));

108 ià(
poŞ
->
queue_şo£
 ||…oŞ->
poŞ_şo£
)

110 
±h»ad_mu‹x_uÆock
(&(
poŞ
->
mu‹x
));

113 
job
 *
pjob
 =(job*è
m®loc
((job));

114 ià(
NULL
 =ğ
pjob
)

116 
±h»ad_mu‹x_uÆock
(&(
poŞ
->
mu‹x
));

119 
mem£t
(
pjob
, 0, (
job
));

120 
pjob
->
ÿÎback
 = callback;

121 
pjob
->
¬g
 =‡rg;

122 
pjob
->
Ãxt
 = 
NULL
;

123 ià(
poŞ
->
h—d
 =ğ
NULL
)

125 
poŞ
->
h—d
 =…oŞ->

 = 
pjob
;

126 
±h»ad_cÚd_brßdÿ¡
(&(
poŞ
->
queue_nÙ_em±y
));

130 
poŞ
->

->
Ãxt
 = 
pjob
;

131 
poŞ
->

 = 
pjob
;

133 
poŞ
->
queue_cur_num
++;

134 
±h»ad_mu‹x_uÆock
(&(
poŞ
->
mu‹x
));

139 * 
th»adpoŞ_funùiÚ
(* 
¬g
)

141 
th»adpoŞ
 *
poŞ
 = (th»adpoŞ*)
¬g
;

142 
job
 *
pjob
 = 
NULL
;

146 
±h»ad_mu‹x_lock
(&(
poŞ
->
mu‹x
));

147 (
poŞ
->
queue_cur_num
 =ğ0è&& !poŞ->
poŞ_şo£
)

149 
±h»ad_cÚd_wa™
(&(
poŞ
->
queue_nÙ_em±y
), &ÕoŞ->
mu‹x
));

151 ià(
poŞ
->
poŞ_şo£
)

153 
±h»ad_mu‹x_uÆock
(&(
poŞ
->
mu‹x
));

154 
±h»ad_ex™
(
NULL
);

156 
poŞ
->
queue_cur_num
--;

157 
pjob
 = 
poŞ
->
h—d
;

158 ià(
poŞ
->
queue_cur_num
 == 0)

160 
poŞ
->
h—d
 =…oŞ->

 = 
NULL
;

164 
poŞ
->
h—d
 = 
pjob
->
Ãxt
;

166 ià(
poŞ
->
queue_cur_num
 == 0)

168 
±h»ad_cÚd_sigÇl
(&(
poŞ
->
queue_em±y
));

170 ià(
poŞ
->
queue_cur_num
 <…oŞ->
queue_max_num
)

172 
±h»ad_cÚd_brßdÿ¡
(&(
poŞ
->
queue_nÙ_fuÎ
));

174 
±h»ad_mu‹x_uÆock
(&(
poŞ
->
mu‹x
));

176 
pjob
->
ÿÎback
Õjob->
¬g
);

177 
ä“
(
pjob
);

178 
pjob
 = 
NULL
;

182 
th»adpoŞ_de¡roy
(
th»adpoŞ
 *
poŞ
)

184 
as£¹
(
poŞ
 !ğ
NULL
);

186 
±h»ad_mu‹x_lock
(&(
poŞ
->
mu‹x
));

187 ià(
poŞ
->
queue_şo£
 ||…oŞ->
poŞ_şo£
)

189 
±h»ad_mu‹x_uÆock
(&(
poŞ
->
mu‹x
));

193 
poŞ
->
queue_şo£
 = 1;

194 
poŞ
->
queue_cur_num
 != 0)

196 
±h»ad_cÚd_wa™
(&(
poŞ
->
queue_em±y
), &ÕoŞ->
mu‹x
));

199 
poŞ
->
poŞ_şo£
 = 1;

200 
±h»ad_mu‹x_uÆock
(&(
poŞ
->
mu‹x
));

201 
±h»ad_cÚd_brßdÿ¡
(&(
poŞ
->
queue_nÙ_em±y
));

202 
±h»ad_cÚd_brßdÿ¡
(&(
poŞ
->
queue_nÙ_fuÎ
));

203 
i
;

204 
i
 = 0; i < 
poŞ
->
th»ad_num
; ++i)

206 
±h»ad_još
(
poŞ
->
±h»ads
[
i
], 
NULL
);

209 
±h»ad_mu‹x_de¡roy
(&(
poŞ
->
mu‹x
));

210 
±h»ad_cÚd_de¡roy
(&(
poŞ
->
queue_em±y
));

211 
±h»ad_cÚd_de¡roy
(&(
poŞ
->
queue_nÙ_em±y
));

212 
±h»ad_cÚd_de¡roy
(&(
poŞ
->
queue_nÙ_fuÎ
));

213 
ä“
(
poŞ
->
±h»ads
);

214 
poŞ
->
±h»ads
 = 
NULL
;

215 
job
 *
p
;

216 
poŞ
->
h—d
 !ğ
NULL
)

218 
p
 = 
poŞ
->
h—d
;

219 
poŞ
->
h—d
 = 
p
->
Ãxt
;

220 
ä“
(
p
);

221 
p
 = 
NULL
;

223 
ä“
(
poŞ
);

224 
poŞ
 = 
NULL
;

229 
th»adpoŞ_­i_ü—‹
(
th»ad_num
)

231 if(1 =ğ
g_bth»adpoŞ_š™
)

233  
NULL
;

236 
g¡_±h»adpoŞ
 = 
th»adpoŞ_š™
(
th»ad_num
, 10);

237 if(
NULL
 =ğ
g¡_±h»adpoŞ
)

242 
g_bth»adpoŞ_š™
 = 1;

247 
th»adpoŞ_­i_addsk
(
EPOLL_EV_CB
 
ÿÎback
, *
¬g
)

249  
th»adpoŞ_add_job
(
g¡_±h»adpoŞ
, 
ÿÎback
, 
¬g
);

252 
th»adpoŞ_­i_de¡Üy
()

254 if(0 =ğ
g_bth»adpoŞ_š™
)

259 
th»adpoŞ_de¡roy
(
g¡_±h»adpoŞ
);

261 
g_bth»adpoŞ_š™
 = 0;

265 #ifdeà
__ılu¥lus


	@threadpool.h

1 #iâdeà
__THREADPOOL_H__


2 
	#__THREADPOOL_H__


	)

4 #ifdeà
__ılu¥lus


8 
	~<time.h
>

9 
	~<¡dio.h
>

10 
	~<sigÇl.h
>

11 
	~<fú.h
>

12 
	~<¡dlib.h
>

13 
	~<uni¡d.h
>

14 
	~<¡ršg.h
>

15 
	~<”ºo.h
>

16 
	~<sys/sock‘.h
>

17 
	~<Ãtš‘/š.h
>

18 
	~<±h»ad.h
>

19 
	~<¬·/š‘.h
>

20 
	~<sys/•Şl.h
>

21 
	~<sys/ty³s.h
>

22 
	~<as£¹.h
>

24 (*
EPOLL_EV_CB
)(*
	t¬g
);

26 
th»adpoŞ_­i_ü—‹
(
th»ad_num
);

27 
th»adpoŞ_­i_de¡Üy
();

28 
th»adpoŞ_­i_addsk
(
EPOLL_EV_CB
 
ÿÎback
, *
¬g
);

31 #ifdeà
__ılu¥lus


	@
1
.
0
2
26
threadpool.c
threadpool.h
